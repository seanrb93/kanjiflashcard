name: CI Template

on:
  workflow_call:
    inputs:
      registry_url:
        required: true
        type: string
      registry_auth:
        required: false
        type: boolean
        default: false
      tf_directory:
        required: true
        type: string
      tf_vars:
        required: false
        type: string
      push_image:
        required: true
        type: boolean

jobs:
  pipeline:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: kanji-flashcards
      IMAGE_TAG: latest
      FULL_IMAGE: ${{ inputs.registry_url }}/kanji-flashcards:latest
      TF_DIRECTORY: ./terraform

    steps:
    - name: Checkout current branch
      uses: actions/checkout@v4

    - name: Run Unit Tests
      run: mvn test --batch-mode

    - name: Build App
      run: mvn -B package

    - name: Build Docker Image
      run: docker build -t ${{ env.FULL_IMAGE }} .

    - name: Scan Docker Image (Trivy)
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: ${{ env.FULL_IMAGE }}
        exit-code: '1'
        severity: CRITICAL,HIGH

    - name: Login to Registry
      if: inputs.registry_auth == true
      run: echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ inputs.registry_url }} -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin

    - name: Push Docker Image
      if: inputs.push_image == true
      run: docker push ${{ env.FULL_IMAGE }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      working-directory: ${{ inputs.tf_directory }}
      run: terraform init -input=false

    - name: Terraform Apply
      working-directory: ${{ inputs.tf_directory }}
      run: terraform apply -auto-approve ${{ inputs.tf_vars }}
